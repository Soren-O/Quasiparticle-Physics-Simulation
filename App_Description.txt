Name: Quasiparticle Physics Simulator

Overview
This desktop Python application provides a full workflow for building, saving, running, and reviewing quasiparticle-inspired diffusion simulations on 2D geometries. The current physics engine is a 2D heat/diffusion equation solver using a Crank-Nicolson time integrator. Geometry can come from imported GDSII layouts or an intrinsic built-in geometry for quick testing.

The app is designed around:
1. Interactive boundary-condition assignment on geometry edges.
2. Flexible initial conditions (including constrained custom expressions).
3. Simulation playback and persistence to JSON.
4. Analytic-vs-numerical validation test suites with multiple geometries.

Design and UX direction
- Retro-style desktop UI inspired by pre-Windows-XP controls.
- Start screen contains:
  - "Run Quasiparticle Physics Simulator"
  - "Install Requirements.bat"
- Main menu contains:
  - Create New Setup
  - Load Saved Setup
  - View Saved Simulations
  - Generate Test Simulations
  - View Test Simulations
  - Back To Start Screen

--------------------------------------------------------------------------------
Core setup flow (Create New Setup)
--------------------------------------------------------------------------------

Geometry input
- Users can import `.gds` geometry.
- If only one layer exists, the app uses it.
- If multiple layers are present, the user is prompted to choose which layer to import.
- Imported geometry is rasterized onto the simulation mesh.
- Connectivity is validated: geometry must contain exactly one connected region.
- A built-in "Use Intrinsic Test Geometry" option is also available for quick setup without GDS.

Geometry interaction and edge picking
- The geometry is rendered in the setup editor.
- Hovering near a boundary edge highlights it.
- Clicking a highlighted edge opens boundary condition assignment.
- Each boundary edge segment must be assigned before simulation can run.
- "Set Unassigned -> Reflective" is available as a fast-fill utility.

Boundary condition types currently supported
- Reflective (insulated, zero flux).
- Neumann (non-zero outward gradient, numeric value required).
- Dirichlet (fixed boundary value, numeric value required).
- Absorbing (sink-like boundary behavior).
- Robin (mixed condition, primary value required, auxiliary value optional).

Simulation parameters collected in setup editor
- Diffusion coefficient `D`.
- Mesh size `dx` (must match imported geometry mesh).
- Time step `dt`.
- Total simulation time.
- Storage stride (`store_every`).

Initial conditions
- Configurable through a dedicated popup.
- Built-in kinds:
  - Gaussian (`amplitude`, `x0`, `y0`, `sigma`)
  - Uniform (`value`)
  - Point source (`value`, `x0`, `y0`)
  - Custom expression
- Custom expression mode provides:
  - A fixed scaffold function signature (`user_expression(x, y, params)`).
  - Editable function body.
  - JSON dictionary for custom parameters.
- Custom expressions are evaluated per interior cell with normalized coordinates.

Save/load behavior
- Setup can be saved at any point to JSON.
- Saved setup JSON can be loaded later and reopened in the editor.

--------------------------------------------------------------------------------
Simulation execution and viewing
--------------------------------------------------------------------------------

Run behavior
- Simulation cannot run until all edges have boundary assignments.
- The solver runs on the 2D interior mask using Crank-Nicolson.
- Frames, time values, and mass-over-time are generated and persisted.
- Results are saved to JSON.

Live viewing behavior
- The setup editor now uses a checkbox:
  - "View Live Simulation On Run"
- If checked, pressing "Run Simulation" automatically opens the simulation viewer after the run completes.
- If unchecked, the run completes normally and shows completion feedback.

Simulation viewer content
- Left panel: 2D heatmap of the field over geometry.
- Right panel: mass-over-time trace.
- Heatmap uses fixed color scaling for temporal consistency.
- Playback controls include play/pause and frame stepping.

Saved simulation viewing
- From the main menu, users can browse saved simulation JSON files and open them in the same viewer.

--------------------------------------------------------------------------------
Test simulation system (validation workflows)
--------------------------------------------------------------------------------

Purpose
The test system validates the numerical backend against analytic references across multiple boundary-condition and geometry regimes.

Generation flow
- "Generate Test Simulations" runs in a background worker thread.
- A modal busy dialog with a progress bar is shown so the app does not appear frozen.

Viewing flow
- "View Test Simulations" first loads a lightweight suite manifest.
- A geometry landing page is shown with preview images/cards.
- Opening a geometry lazily loads only that geometry's case payload.
- A busy dialog is shown while loading heavy geometry cases.

Current geometry groups in generated test suites
1. Effective 1D Strip (`strip_1d_effective`)
   - Implemented with the full 2D solver on a one-cell-thick strip.
   - This is intentionally "effectively 1D" without a separate 1D solver.
   - 10 validation cases total (2 per boundary condition family).
   - Display mode: line plot replay (simulated vs analytic traces).

2. 2D Rectangle (`rectangle_2d`)
   - True 2D rectangle, not effectively 1D.
   - 6 analytic sine-mode benchmark cases.
   - Display mode: side-by-side heatmaps (simulated vs analytic).

3. Polygon Donut (`polygon_donut`)
   - Polygonal annulus (concentric regular polygons, symmetric construction).
   - 4 radial Bessel-mode benchmark cases.
   - Display mode: side-by-side heatmaps (simulated vs analytic).

Current default test-suite parameters
- `dx = 1.0`
- `D = 25.0`
- `dt = 0.05`
- `total_time = 8.0`
- `store_every = 2`

Test replay presentation
- Case navigation: Prev/Next.
- Time slider and playback.
- On-screen equation/info panel with:
  - Boundary condition label
  - Analytic formula (LaTeX-style text)
  - Initial condition formula
  - Case description
- Heatmap viewers include a persistent color legend ("Density") shared across simulated/analytic panels.

--------------------------------------------------------------------------------
Data persistence format
--------------------------------------------------------------------------------

Directories
- Setups: `data/setups/*.json`
- Simulations: `data/simulations/*.json`
- Test suites:
  - Manifest: `data/test_cases/test_suite_<id>.json`
  - Geometry payload files: `data/test_cases/test_suite_<id>/<geometry_id>.json`

Test suite format notes
- Newer format writes a lightweight manifest plus per-geometry sidecar files.
- This allows fast initial loading and lazy loading of case-heavy geometry groups.
- Backward compatibility exists for older flat test-suite formats.

Git and repo notes
- Repository includes `.gitignore` entries for generated artifacts, including split test-suite directories (`data/test_cases/test_suite_*/`).

--------------------------------------------------------------------------------
Physics and implementation notes
--------------------------------------------------------------------------------

Numerical backend
- PDE modeled as diffusion/heat equation in 2D.
- Spatial operator assembled from interior mask and boundary-face assignments.
- Time integration uses Crank-Nicolson linear solves.

Boundary handling
- Reflective, Neumann, Dirichlet, Absorbing, and Robin conditions are all represented at boundary faces extracted from edge segments.

Analytic benchmarking philosophy
- "Simulated" data is produced by the solver run.
- "Analytic" data is produced from closed-form/eigenmode expressions per case.
- Both are stored and replayed together for visual comparison.

--------------------------------------------------------------------------------
Install and run
--------------------------------------------------------------------------------

Install (manual)
```powershell
python -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt
```

Install (batch script)
```powershell
.\Install Requirements.bat
```

Run (manual)
```powershell
python app.py
```

Run (batch script)
```powershell
.\Run Quasiparticle Physics Simulator.bat
```

--------------------------------------------------------------------------------
Reference material used for formulation/validation
--------------------------------------------------------------------------------

Local references in repo
- `References/2DCrank.pdf`
- `References/ChapterSimulation.txt`
- `References/ChapterAppendix.txt`
- `References/Quasiparticle_Master_Equation.pdf`

Analytic PDE references used in test-case design
- https://math.stackexchange.com/questions/4720247/1d-heat-equation-with-insulated-boundary-conditions-greens-function
- https://math.stackexchange.com/questions/4723649/1d-heat-equation-with-insulated-boundaries-with-dirac-delta
- https://www.math.toronto.edu/ivrii/PDE-textbook/Chapter4/S4.1.html
- https://www.math.toronto.edu/ivrii/PDE-textbook/Chapter6/S6.1.html
- https://www.math.toronto.edu/ivrii/PDE-textbook/Chapter3/S3.2.html
- https://www.math.toronto.edu/ivrii/PDE-textbook/Chapter4/S4.2.html
