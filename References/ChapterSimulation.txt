umentclass[../main]{subfiles}
\begin{document}
\chapter{Quasiparticle Master Equation}

\section{Quasiparticle Density}

Let $N_{\qp}$ be the total number of quasiparticles in a superconductor. The spectral density of these quasiparticles, denoted $N(E,\boldsymbol{r})$, represents the number of quasiparticles per unit volume per unit energy at position $\boldsymbol{r}$ and energy $E$. The total number is found by integrating this density over the volume and all allowed quasiparticle energies:
\begin{equation}
    N_{\qp} = \int_V \int_{\text{allowed } E} N(E,\boldsymbol{r}) \, dE \, dV. \label{eq:Nqp_integral}
\end{equation}
In a superconductor with an energy gap $\Delta(\boldsymbol{r})$, there are no quasiparticle states for $E < \Delta(\boldsymbol{r})$, so the integral is taken from the gap edge to infinity.

\subsection{Momentum-Space Representation}
% --- NEW CONTENT: BCS GROUND STATE ---
To understand the origin of the quasiparticle states, we first consider the ground state of the superconductor in the BCS framework. This state is a coherent superposition of Cooper-paired electron states, represented by the wavefunction:
\begin{equation}
    |\Psi_0\rangle = \prod_{\boldsymbol{k}} \left( u_{\boldsymbol{k}} + v_{\boldsymbol{k}} c^\dagger_{\boldsymbol{k}\uparrow} c^\dagger_{-\boldsymbol{k}\downarrow} \right) |0\rangle,
\end{equation}
where $u_{\boldsymbol{k}}$ and $v_{\boldsymbol{k}}$ are the BCS coherence factors and $c^\dagger$ are electron creation operators. Quasiparticles are the elementary excitations above this ground state.
% --- END OF NEW CONTENT ---
We can express their energy in terms of the kinetic energy of the normal-state electrons relative to the Fermi level, $\epsilon = p^2/2m - \epsilon_F$. The quasiparticle energy is then given by the Bogoliubov dispersion relation:
\begin{equation}
    E(\epsilon) = \sqrt{\epsilon^2 + \Delta^2}.
\end{equation}
In this representation, the total number of quasiparticles is found by integrating over all electron and hole states. For a spatially uniform gap $\Delta$, this is:
\begin{equation}\label{eq:Nqp_epsilon}
    N_{\qp} = \int_V\int_{-\epsilon_F}^{+\infty} 2N(0) \, f(E(\epsilon)) \, d\epsilon \approx \int_V\int_{-\infty}^{+\infty} 2N(0) \, f(E(\epsilon)) \, d\epsilon.
\end{equation}
Here $N(0)$ is the \textit{single}-spin density of states at the Fermi level (approximated as constant), and hence the factor of $2$ appears. The function $f(E)$ is the occupation probability of a state with energy $E$. In thermal equilibrium, it is the Fermi-Dirac distribution:
\begin{equation}
    f(E, T) = \frac{1}{e^{E/(k_B T)} + 1}.
\end{equation}
The error introduced by changing the lower limit of integration to $-\infty$ is negligible because $f(E(-\epsilon_F))$ is effectively zero for typical energy scales, which is the case when $f(E)$ is a Fermi-Dirac distribution at any relevant temperature.

\subsubsection{Transformation to Energy Space}
We can transform the momentum-space integral (Eq. \ref{eq:Nqp_epsilon}) back into the energy-space representation of Eq. \eqref{eq:Nqp_integral} to find an explicit expression for the spectral density $N(E, \boldsymbol{r})$. First, we note the differential relation from $E = \sqrt{\epsilon^2 + \Delta^2}$:
\begin{equation}
    d\epsilon = \frac{E}{\sqrt{E^2 - \Delta^2}} \, dE.
\end{equation}
The mapping $E(\epsilon)$ is two-to-one: both $\epsilon > 0$ (electron-like) and $\epsilon < 0$ (hole-like) map to the same quasiparticle energy $E$. We can therefore split the integral over $\epsilon$ and use its symmetry, $E(\epsilon) = E(-\epsilon)$:
\begin{equation}
\begin{split}
    N_{\qp} &= \int_V \left( \int_{-\infty}^{0} 2N(0) f(E(\epsilon)) \, d\epsilon + \int_{0}^{+\infty} 2N(0) f(E(\epsilon)) \, d\epsilon \right) dV  \\
    &= \int_V \int_{0}^{+\infty} 4N(0) f(E(\epsilon)) \, d\epsilon \, dV.
\end{split}
\end{equation}
Changing variables from $\epsilon$ to $E$ (where $\epsilon \in [0, \infty)$ maps to $E \in [\Delta, \infty)$) yields:
\begin{equation}
    N_{\qp} = \int_V\int_{\Delta}^{\infty} 4N(0) f(E) \frac{E}{\sqrt{E^2 - \Delta^2}} \, dE \, dV. \label{eq:Nqp_energy_space}
\end{equation}
Note: $N(0)$ is the single-spin DOS. The factor $4 N(0)$ reflects both spin degeneracy ($\times 2$) and the two-to-one mapping of $\epsilon \leftrightarrow \pm|\epsilon|$ onto a single quasiparticle energy $E$ ($\times 2$). For tunneling, the relevant electronic DOS is $2 N(0) \rho(E)$; here we are counting Bogoliubov quasiparticles, which introduces an additional factor of 2. This agrees with the form in \cite{Zmuidzinas}.

Comparing this result with Eq. \eqref{eq:Nqp_integral} provides the explicit form of the spectral density. Generalizing to the case where properties may vary spatially, we get:
\begin{equation}
    N(E,\boldsymbol{r}) = 4 N(0,\boldsymbol{r}) \frac{E}{\sqrt{E^2 - \Delta(\boldsymbol{r})^2}} \, f(E,\boldsymbol{r}), \quad \text{for } E \ge \Delta(\boldsymbol{r}).
\end{equation}
Even if the underlying material is chemically homogeneous, the gap $\Delta(\boldsymbol{r})$ may vary because of, for example, local variations in the thickness of a superconducting film. In these cases, the normal-state density of states $N(0)$ can still be treated as spatially uniform and factored out of the volume integral.

Doing so allows us to define a set of related quantities which are convenient for analysis and simulation. First, we define the \term{normalized BCS density of states}:
\begin{equation}
    \rho(E,\boldsymbol{r}) = \frac{E}{\sqrt{E^2 - \Delta(\boldsymbol{r})^2}}.
\end{equation}

This expression for $\rho(E, \boldsymbol{r})$ has a singularity at the gap edge, $E=\Delta$. In many practical situations, particularly when comparing with experimental data, it is useful to include a phenomenological lifetime broadening effect. This is accomplished using the \term{Dynes density of states}, which introduces a broadening parameter $\Gamma$:
\begin{equation}
\rho(E, \boldsymbol{r}, \Gamma) = \operatorname{Re}\left\{\frac{E - i\Gamma}{\sqrt{(E - i\Gamma)^2 - \Delta(\boldsymbol{r})^2}}\right\}.
\end{equation}
The parameter $\Gamma$ accounts for processes that give quasiparticle states a finite lifetime, smearing the singularity at the gap edge.

The product of this with the occupation probability gives the \term{normalized quasiparticle spectral density}, a useful dimensionless quantity:
\begin{equation}
    n(E,\boldsymbol{r}) = \rho(E,\boldsymbol{r})f(E,\boldsymbol{r}).
\end{equation}
Integrating this distribution over all allowed energies gives the \term{local quasiparticle density parameter}:
\begin{equation}
    x_{\qp}(\boldsymbol{r}) = \int_{\Delta(\boldsymbol{r})}^{\infty} n(E,\boldsymbol{r}) \, dE.
\end{equation}
This quantity, which has units of energy, is sometimes referred to as a dimensionless density in the literature, a convention that arises if it is implicitly normalized by a characteristic energy like $\Delta_0$ or $k_B T_c$. The total number of quasiparticles is then simply:
\begin{equation}
    N_{\qp} = 4N(0) \int_V x_{\qp}(\boldsymbol{r}) \, dV.
\end{equation}
For non-equilibrium problems, the occupation probability $f(E, \boldsymbol{r})$ may be an arbitrary distribution. In such cases, some of the initial assumptions must be revisited. Specifically, the approximation of extending the integration limit in Eq. \eqref{eq:Nqp_epsilon} to $-\infty$ and the assumption of a constant normal-state density of states, $N(\epsilon) \approx N(0)$, both rely on the relevant physics being confined to a narrow energy window around the Fermi level. If a highly non-equilibrium distribution significantly populates states with large $|\epsilon|$, these approximations could introduce significant errors. However, for many practical non-equilibrium scenarios where the quasiparticle distribution is still primarily concentrated near the gap edge, these standard simplifications remain highly effective.

\section{Quasiparticle Dynamics: The Master Equation}
To model the time evolution of the quasiparticle population, we formulate a master equation for the quasiparticle density. For simplicity, we assume spatial homogeneity and work with the dimensionless spectral density $n(E,t)$. The dominant kinetic processes that we will consider are: quasiparticle-phonon scattering, quasiparticle-quasiparticle recombination, thermal (phonon-mediated) quasiparticle generation, and external sources. We ignore quasiparticle-lattice impurity scattering and quasiparticle-quasiparticle scattering. The master equation can be written conceptually as:
\begin{equation}
\frac{\partial n(E,t)}{\partial t} = \text{Generation} + \text{Scattering In} - \text{Scattering Out} - \text{Recombination}.
\end{equation}

We examine each process:
\begin{itemize}
    \item \term{External Generation} represents quasiparticle creation from external sources such as stray infrared photons, cosmic rays, other high-energy particle impacts, direct quasiparticle injection, or non-equilibrium phonon-mediated generation. This is denoted by a dimensionless rate $g_{\ext}(E)$.

    \item \term{Thermal Generation} occurs when thermal phonons with energy $\geq 2\Delta$ break Cooper pairs. We derive this term later via detailed balance.

    \item \term{Scattering} redistributes quasiparticles in energy through phonon exchange. The rates depend on the scattering kernel $K^s(E, E')$ from \citet{Martinis2009energydecayjosephsonqubits} and \citet{Lenander_2011}:
    \begin{equation}
        K^s(E, E') = \frac{1}{\tau_{0}} \frac{(E-E')^{2}}{(k_B T_{c})^{3}} \left(1-\frac{\Delta^{2}}{EE'}\right) N_p(E-E'),
    \end{equation}
    where $\tau_0$ is a material-specific electron-phonon interaction time, $T_c$ is the critical temperature, $(1 - \Delta^2/EE')$ is the BCS coherence factor, and $N_p(E_{\eph})$ is the effective phonon occupation factor.\footnote{The phonon occupation factor $N_p(E_{\eph})$ is a compact notation that handles both phonon emission and absorption. For a thermal phonon bath at temperature $T_p$, it is given by $N_p(E_{\eph}) = 1/|\exp(-E_{\eph}/k_B T_p) - 1|$. When a quasiparticle emits a phonon ($E_{\eph} > 0$), this term evaluates to $1+n_{BE}(E_{\eph})$. When it absorbs a phonon ($E_{\eph} < 0$), it evaluates to $n_{BE}(|E_{\eph}|)$.}

    \item \term{Recombination} removes quasiparticles when two of them combine to form a Cooper pair. The rate depends on the recombination kernel $K^r(E, E')$, also from \citet{Martinis2009energydecayjosephsonqubits} and \citet{Lenander_2011}:
    \begin{equation}
        K^r(E, E') = \frac{1}{\tau_{0}} \frac{(E+E')^{2}}{(k_B T_{c})^{3}} \left(1+\frac{\Delta^{2}}{EE'}\right) N_p(E+E').
    \end{equation}
\end{itemize}

The full master equation for the dimensionless quasiparticle density $n(E,t)$ is:
\begin{equation}\label{eq:master_full}
\begin{split}
\frac{\partial n(E,t)}{\partial t} = &g_{\ext}(E) + G_{\therm}(E) \\
&+ \int_{\Delta}^{\infty}  n(E') K^s(E', E) \rho(E) \left[1-\frac{n(E)}{\rho(E)}\right] \, dE' \\
&- n(E) \int_{\Delta}^{\infty} K^s(E, E') \rho(E') \left[1-\frac{n(E')}{\rho(E')}\right] \, dE' \\
&- 2n(E)\int_{\Delta}^{\infty} K^r(E, E') n(E') \, dE'.
\end{split}
\end{equation}
The Pauli blocking factor is written as $[1-f(E)] = [1 - n(E)/\rho(E)]$. The factor of 2 in the recombination term arises because the loss of a quasiparticle at energy $E$ is due to its recombination with a quasiparticle at any other energy $E'$, and this process is symmetric \citep{Wenner2012erratum}. For brevity, the entire right-hand side of Eq. (\ref{eq:master_full}), representing all local generation and kinetic processes, is often collected into a single term called the \term{collision integral}, $\mathcal{I}_{\coll}[n]$.

\subsection{Determination of Thermal Generation Rate}
We derive the thermal generation rate $G_{\therm}(E)$ by invoking the principle of detailed balance. We assume the system is in thermal equilibrium at temperature $T$. The quasiparticle density is given by the Fermi-Dirac distribution, $n_{\eq}(E, T) = \rho(E) f_{\eq}(E, T)$, where $f_{\eq}(E,T) = (e^{E/k_B T} + 1)^{-1}$, and the phonons are described by a Bose-Einstein distribution.

At equilibrium, the net rate of change for any process must be zero. For scattering, this means the scattering-in and scattering-out rates must be equal. This equality is guaranteed by a fundamental property of the scattering kernel:
\begin{equation}\label{eq:kernel_balance}
    K^s(E, E') = K^s(E', E) e^{(E-E')/k_B T}.
\end{equation}

\subsubsection{Derivation of the Kernel Balance Property}
The kernel property in Eq. (\ref{eq:kernel_balance}) arises from the Bose-Einstein statistics of the mediating phonons, encapsulated in the term $N_p(E_{\eph})$. Letting $x = (E-E')/k_B T$, the property is equivalent to proving the identity $N_p(-x) = N_p(x)e^{-x}$, or:
\begin{equation}
    \frac{1}{|\exp(x)-1|} = \frac{e^{-x}}{|\exp(-x)-1|}.
\end{equation}
We prove this by starting with the right-hand side:
\begin{align*}
    \frac{e^{-x}}{|\exp(-x)-1|} &= \frac{e^{-x}}{|e^{-x}(1 - e^{x})|} = \frac{e^{-x}}{|e^{-x}| \cdot |1 - e^{x}|} \\
    &= \frac{e^{-x}}{e^{-x} |1 - e^{x}|} \quad (\text{since } e^{-x} > 0) \\
    &= \frac{1}{|1 - e^{x}|} = \frac{1}{|e^{x}-1|}.
\end{align*}
This confirms the detailed balance relation for the scattering kernel.

\subsubsection{Proof of Scattering Rate Balance at Equilibrium}
We now explicitly show that the kernel property in Eq. (\ref{eq:kernel_balance}) ensures that the total scattering-in rate equals the total scattering-out rate at thermal equilibrium. The scattering-in and scattering-out rates to energy $E$ are given by:
\begin{align}
    \text{Rate In}(E) &= \int_{\Delta}^{\infty} n_{\eq}(E') K^s(E', E) \rho(E) \left[1-f_{\eq}(E)\right] \, dE' \\
    \text{Rate Out}(E) &= n_{\eq}(E) \int_{\Delta}^{\infty} K^s(E, E') \rho(E') \left[1-f_{\eq}(E')\right] \, dE'.
\end{align}
To prove these are equal, we transform the ``Rate In'' expression using equilibrium relationships. First, substitute the kernel property from Eq. (\ref{eq:kernel_balance}) and the definition $n_{\eq}(E') = \rho(E') f_{\eq}(E')$:
\begin{equation}
    \text{Rate In}(E) = \int_{\Delta}^{\infty} \rho(E') f_{\eq}(E') \left( K^s(E, E') e^{(E'-E)/k_B T} \right) \rho(E) \left[1-f_{\eq}(E)\right] \, dE'.
\end{equation}
A key identity for fermions in thermal equilibrium is $f_{\eq}(E') \left[1-f_{\eq}(E)\right] e^{(E'-E)/k_B T} = f_{\eq}(E) \left[1-f_{\eq}(E')\right]$. Substituting this gives:
\begin{equation}
    \text{Rate In}(E) = \int_{\Delta}^{\infty} K^s(E, E') \rho(E') \rho(E) \left( f_{\eq}(E) \left[1-f_{\eq}(E')\right] \right) \, dE'.
\end{equation}
Rearranging and recognizing that $\rho(E)f_{\eq}(E) = n_{\eq}(E)$ yields the desired result:
\begin{align}
    \text{Rate In}(E) &= n_{\eq}(E) \int_{\Delta}^{\infty} K^s(E, E') \rho(E') \left[1-f_{\eq}(E')\right] \, dE' = \text{Rate Out}(E).
\end{align}
Thus, the net scattering contribution at thermal equilibrium is zero.

\subsubsection{Thermal Generation Rate}
With the net scattering rate confirmed to be zero, the master equation at equilibrium ($\partial n/\partial t = 0$) with no external sources ($g_{\ext}=0$) simplifies to a balance between thermal generation and recombination:
\begin{equation}
    0 = G_{\therm}(E) - \text{Recombination}_{\eq} = G_{\therm}(E) - 2 n_{\eq}(E) \int_{\Delta}^{\infty} K^r(E, E') n_{\eq}(E') \, dE'.
\end{equation}
Therefore, the thermal generation rate required to maintain equilibrium is:
\begin{equation}
    G_{\therm}(E) = 2 n_{\eq}(E) \int_{\Delta}^{\infty}  K^r(E, E') n_{\eq}(E') \, dE'.
\end{equation}
Substituting this back into Eq. (\ref{eq:master_full}) gives the final master equation.

\section{Spatially-Resolved Dynamics: The Reaction-Diffusion Equation}
To model systems with spatial inhomogeneity, we must include a transport term. Assuming quasiparticle motion is diffusive, the full dynamics of the spectral density $n(E, \boldsymbol{r}, t)$ are described by a reaction-diffusion equation:
\begin{equation}\label{eq:Final}
    \frac{\partial n(E,\boldsymbol{r}, t)}{\partial t} = \nabla \cdot \left[ D(E, n, \boldsymbol{r})\nabla n(E, \boldsymbol{r}, t)\right] + \mathcal{I}_{\coll}[n(E, \boldsymbol{r}, t)],
\end{equation}
where $D(E, n, \boldsymbol{r})$ is the diffusion coefficient. Its dependence on position $\boldsymbol{r}$ arises primarily from the local energy gap $\Delta(\boldsymbol{r})$, and $\Delta$ may also in turn depend on the quasiparticle density $n$. The term $\mathcal{I}_{\coll}$ is the collision integral, representing all local generation and kinetic terms as defined on the right-hand side of Eq. (\ref{eq:master_full}).

In one dimension, the diffusion term expands as:
\begin{equation}
    \frac{\partial}{\partial x} \left[ D \frac{\partial n}{\partial x} \right] = \frac{\partial D}{\partial x}\frac{\partial n}{\partial x} + D\frac{\partial^2 n}{\partial x^2}.
\end{equation}
Because the diffusion coefficient $D$ can depend on the density $n$, the chain rule must be applied carefully: $\frac{\partial D}{\partial x} = \frac{\partial D}{\partial n}\frac{\partial n}{\partial x} + \dots$. This introduces a term proportional to $(\partial n / \partial x)^2$, making the full reaction-diffusion equation non-linear.

\subsection{Energy-Dependent Diffusion Coefficient}
The energy dependence of the diffusion coefficient can be derived from kinetic theory, where $D \approx \frac{1}{3} v_g \lambda$, with $v_g$ being the quasiparticle group velocity and $\lambda$ the mean free path. The group velocity is given by:
\begin{equation}
    v_g = \frac{1}{\hbar}\frac{dE}{dk} = \frac{1}{\hbar}\frac{dE}{d\epsilon}\frac{d\epsilon}{dk} = \frac{\epsilon}{\hbar E} \frac{d}{dk}\left(\frac{p^2}{2m}\right) = \frac{\epsilon}{E} \frac{p}{m} = \frac{\sqrt{E^2 - \Delta^2}}{E} v_F,
\end{equation}
where $v_F$ is the Fermi velocity. Assuming the mean free path $\lambda$ for quasiparticle scattering is approximately the same as in the normal state, the diffusion coefficient in the superconducting state, $D_S$, scales with the group velocity relative to the normal state:
\begin{equation}
D(E,\boldsymbol{r}) = D_0 \frac{v_g}{v_F} = D_0 \sqrt{1 - \left(\frac{\Delta(\boldsymbol{r})}{E}\right)^2},
\end{equation}
where $D_0$ is the diffusion coefficient in the normal state. This expression naturally incorporates the phenomenon of \term{quasiparticle trapping}: in a region where a quasiparticle's energy $E$ is less than the local gap $\Delta(\boldsymbol{r})$, its group velocity and diffusion coefficient become imaginary, meaning it cannot propagate. Physically, we set $D(E, \boldsymbol{r}) = 0$ for $E < \Delta(\boldsymbol{r})$, trapping the quasiparticle.

\section{Quasiparticle Dynamics: Numerical Simulation}
To solve the full reaction-diffusion equation (Eq. \ref{eq:Final}), we employ a numerical approach based on the method of lines, discretizing both the spatial and energy domains. This allows us to model the behavior of the quasiparticle spectral density $n(E, \boldsymbol{r}, t)$ in time.
\subsection{Discretization Scheme}
We focus on a one-dimensional system, discretizing the spatial coordinate $x$ into $N_x$ pixels of width $\Delta x$, indexed by $k = 1, \dots, N_x$. The energy domain is discretized into $N_E$ bins of constant width $\Delta E$ above the minimum gap $\Delta_{\min}$, indexed by $i = 1, \dots, N_E$. The spectral density at a given time step $m$ is thus represented by a matrix $n_{i,k}^m = n(E_i, x_k, t_m)$.

To solve the time evolution, we use \term{operator splitting}. In this approach, for each small time step $\Delta t$, we sequentially apply the effects of the diffusion operator and the collision operator.
\begin{enumerate}
    \item \textbf{Collision Step:} For each spatial pixel $k$, we solve the master equation (the collision integral) for all energy bins $i$, updating the density from $n_{i,k}^m$ to an intermediate state $n_{i,k}^*$.
    \item \textbf{Diffusion Step:} For each energy bin $i$, we solve the diffusion equation for all spatial pixels $k$, updating the density from the intermediate state $n_{i,k}^*$ to the final state at the next time step, $n_{i,k}^{m+1}$.
\end{enumerate}

\subsection{The Discretized Collision Integral}
The collision integral $\mathcal{I}_{\coll}[n]$ contains all local kinetic processes. At each spatial pixel $k$, its discretized form for the $i$-th energy bin is:
\begin{equation}
\begin{split}
\mathcal{I}_{\coll}[n_{i,k}] = &g_{\ext}(E_i, x_k) + G_{\therm}(E_i, x_k) \\
&+ \Delta E \cdot \rho_{i,k} [1-f_{i,k}] \sum_{j=1}^{N_E} n_{j,k} K^s_{ji,k} \\
&- n_{i,k} \Delta E \sum_{j=1}^{N_E} K^s_{ij,k} \rho_{j,k} [1-f_{j,k}] \\
&- 2 n_{i,k} \Delta E \sum_{j=1}^{N_E} K^r_{ij,k} n_{j,k}.
\end{split}
\end{equation}
Here, $\rho_{i,k} = \rho(E_i, x_k)$, $f_{i,k} = n_{i,k}/\rho_{i,k}$, and the kernels $K^s_{ij,k} = K^s(E_i, E_j)$ and $K^r_{ij,k} = K^r(E_i, E_j)$ are evaluated at the local gap $\Delta(x_k)$. This system of ordinary differential equations, $\partial n_{i,k} / \partial t = \mathcal{I}_{\coll}[n_{i,k}]$, is typically stiff and is solved for one time step using an appropriate ODE solver (e.g., an implicit Runge-Kutta method).

\subsection{The Discretized Diffusion Equation}
The diffusion part of the evolution, $\partial n / \partial t = \nabla \cdot [D \nabla n]$, is solved using the \term{Crank-Nicolson scheme}, which is unconditionally stable and second-order accurate in both space and time. For a given energy slice $i$, the discretized equation is:
\begin{equation}
\frac{n_k^{m+1} - n_k^m}{\Delta t} = \frac{1}{2} \left( \mathcal{L}[n_k^{m+1}] + \mathcal{L}[n_k^m] \right),
\end{equation}
where we have dropped the energy index $i$ for clarity, and $\mathcal{L}$ is the finite-difference representation of the spatial diffusion operator, $\nabla \cdot [D \nabla n]$. For a non-uniform diffusion coefficient $D_k = D(E_i, n_k, x_k)$, the operator is:
\begin{equation}
\mathcal{L}[n_k] = \frac{1}{\Delta x^2} \left[ D_{k+\frac{1}{2}}(n_{k+1}-n_k) - D_{k-\frac{1}{2}}(n_k-n_{k-1}) \right],
\end{equation}
with the diffusion coefficient evaluated at the pixel boundaries, e.g., $D_{k+\frac{1}{2}} = (D_{k+1} + D_k)/2$.

Rearranging the Crank-Nicolson equation groups the unknown terms at time step $m+1$ on the left and the known terms at time step $m$ on the right, leading to a system of linear equations for the vector of spatial densities $\boldsymbol{n}^{m+1} = [n_1, n_2, \dots, n_{N_x}]^{T}$:
\begin{equation}
\mathbf{A} \boldsymbol{n}^{m+1} = \mathbf{B} \boldsymbol{n}^{m}.
\end{equation}
The matrices $\mathbf{A}$ and $\mathbf{B}$ are tridiagonal and their elements are given by:
\begin{align}
A_{k,k} &= 1 + \frac{\Delta t}{2 \Delta x^2} (D_{k+\frac{1}{2}} + D_{k-\frac{1}{2}}) \\
A_{k, k\pm 1} &= -\frac{\Delta t}{2 \Delta x^2} D_{k\pm\frac{1}{2}} \\
B_{k,k} &= 1 - \frac{\Delta t}{2 \Delta x^2} (D_{k+\frac{1}{2}} + D_{k-\frac{1}{2}}) \\
B_{k, k\pm 1} &= \frac{\Delta t}{2 \Delta x^2} D_{k\pm\frac{1}{2}}
\end{align}
This tridiagonal system can be solved very efficiently for each energy slice using standard algorithms like the Thomas algorithm.

\end{document}