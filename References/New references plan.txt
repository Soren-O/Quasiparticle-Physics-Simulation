New References Plan - Comprehensive Physics Upgrade
Date: 2026-02-27

Scope
- Upgrade this repo from a QP-only reaction-diffusion simulator to a coupled quasiparticle-phonon(-photon) simulator aligned with:
  - Fischer et al. 2023 (coupled kinetic equations for QPs and phonons, numerical discretization and conservation concerns, observables such as Q and frequency shift).
  - Fischer et al. 2024 (pair-breaking photons above 2*Delta, perturbative vs heating regimes, generalized Rothwarf-Taylor density dynamics, fit strategy for low-T saturation).
  - Marchegiani et al. 2025 (gap-asymmetric junction regimes: nonequilibrium, local quasiequilibrium, global quasiequilibrium, full equilibrium; chemical potentials and rate-equation interpretation).
  - BoltzPhlow Documentation (BTE-first formulation, coupled QP/phonon distributions, energy-shell reduction, positivity-aware time evolution, and conservation-first numerics).

Ultimate transport-mode objective
- Final user-facing architecture will provide three selectable transport regimes:
  1. Diffusion limit
     - Existing reaction-diffusion style transport for QPs (and optionally simplified phonon transport).
     - Intended for lambda_mfp << characteristic device length.
  2. Intermediate regime
     - Hybrid model between diffusion and full Boltzmann.
     - Uses moment-closure / flux-limited transport or effective nonlocal corrections while keeping tractable numerics.
     - Intended for transitional cases where diffusion underfits but full BTE is unnecessary/too costly.
  3. Full Boltzmann transport
     - Energy-shell BTE transport + full collision operators.
     - Intended for lambda_mfp comparable to device scales or strongly non-equilibrium transport studies.
- All three modes must share the same collision-physics modules where possible, so only transport closure changes.

BoltzPhlow-specific principles to carry through all phases
- Keep a clear distinction between:
  - full phase-space BTE language (x, k, t), and
  - reduced isotropic energy-space implementation used in this repo (E/omega bins + spatial pixels).
- Design kernels/updates so that number-conserving channels remain conserving after discretization.
- Treat energy conservation as a first-class regression metric (not only shape matching).
- Use positivity-preserving or positivity-recovering time stepping for collision terms by default.
- Build toward a solver structure where QP and phonon equations are solved as a coupled system with local thermalization controls.

Important precondition
- Before adding new physics, fix known solver correctness issues from prior audit:
  1. Non-uniform diffusion BC/source bug.
  2. Precompute compatibility validation.
  3. Collision default and positivity controls.
  4. Missing-BC strictness consistency.
- Rationale: these bugs will contaminate any validation for the new model layers.

--------------------------------------------------------------------------------
Phase 1 (requested first): Separate 2D Phonon Viewer, fixed temperature only
--------------------------------------------------------------------------------
Goal
- Add a dedicated phonon 2D viewer and plumbing without introducing phonon dynamics yet.
- Treat phonons as a fixed-temperature field, spatially constant by default.

Implementation tasks
1. Data model changes
- Extend SimulationResultData in qpsim/models.py with optional phonon outputs:
  - phonon_frames: list[list[list[float | None]]] | None
  - phonon_metadata: dict[str, Any] with at least:
    - mode = "fixed_temperature"
    - phonon_temperature_K
    - omega_bins (optional for future compatibility; can be empty now)

2. Storage support
- Update qpsim/storage.py serialization/deserialization for the two new fields.
- Keep backward compatibility: old files load with phonon fields as None.

3. Solver plumbing (no new phonon physics yet)
- In qpsim/solver.py, add optional generation of phonon frames for each stored timepoint:
  - Fixed scalar map: T_ph(x,y,t) = T_bath.
  - Respect geometry mask and NaN outside mask, same conventions as QP frames.
- Do not couple phonon frames into QP dynamics in this phase.

4. New UI viewer
- Add a standalone PhononViewer class in qpsim/ui/main_app.py:
  - 2D heatmap with same playback controls style as SimulationViewer.
  - Label units explicitly as K (temperature), not density.
  - Fixed colorbar for frame-to-frame consistency.
- Add launch path:
  - "View Phonon Field" button in simulation result contexts.
  - Disabled/hidden when phonon_frames is None.

5. UX clarity
- In setup editor, add a simple checkbox:
  - "Export fixed phonon map (bath temperature)"
- Add tooltip/help text stating: "No phonon kinetics yet; this is a visualization scaffold."

6. Tests for Phase 1
- Serialization round-trip of phonon fields.
- Viewer data integrity test: shape and mask behavior.
- Regression test that enabling phonon export does not change QP outputs.
- Add baseline BoltzPhlow-style diagnostics output fields (placeholders for now):
  - energy_qp_total
  - energy_phonon_total
  - energy_exchange_residual

Phase 1 acceptance criteria
- User can run existing simulation and open a separate phonon viewer.
- Phonon map displays correctly for all frames, with bath temperature.
- No behavioral changes to existing QP dynamics when phonon map export is enabled.

--------------------------------------------------------------------------------
Phase 2: Solver architecture refactor for coupled fields
--------------------------------------------------------------------------------
Goal
- Prepare internals for coupled kinetic equations without changing physics yet.

Tasks
- Introduce an internal simulation state container:
  - qp_state[E, pixel]
  - phonon_state[Omega, pixel] (initialized from fixed thermal distribution)
- Separate solver step APIs:
  - step_external_sources(...)
  - step_qp_collisions(...)
  - step_phonon_collisions(...)
  - step_qp_diffusion(...)
  - step_phonon_transport(...) (stub initially)
- Add config switch for model level:
  - "legacy_qp_only"
  - "qp_plus_phonon_scaffold"
- Add config switch for transport regime (new user-facing selector):
  - "diffusion"
  - "intermediate"
  - "boltzmann"
- Add config switch for numerical engine:
  - "legacy_split_cn"
  - "bte_energy_shell"

BoltzPhlow additions in Phase 2
- Introduce a kernel API that explicitly tags each term:
  - conserves_qp_number: bool
  - exchanges_energy_with_phonons: bool
  - can_change_total_qp_number: bool
- Introduce a conserved-quantity monitor module:
  - monitor_qp_number(...)
  - monitor_total_energy(...)
  - monitor_per_term_budget(...)
- Add a single source of truth for units and scaling constants (k_B, tau_0, DOS normalizations).

Acceptance criteria
- Existing outputs unchanged in legacy mode.
- Scaffold mode runs and stores phonon state arrays cleanly.
- Transport-regime selector is plumbed end-to-end (UI -> parameters -> solver dispatch), even if some modes are stubbed initially.

--------------------------------------------------------------------------------
Phase 2.5: Intermediate regime model definition
--------------------------------------------------------------------------------
Goal
- Specify and implement the first practical hybrid transport closure that sits between diffusion and full BTE.

Tasks
- Define the intermediate transport equation set (first candidate):
  - diffusion-like equation with nonlocal/finite-relaxation correction terms, or
  - two-moment (density + flux) closure with relaxation to diffusive limit.
- Define parameter mapping from physical inputs to closure coefficients:
  - effective mean free path
  - relaxation time
  - energy dependence across bins.
- Add automatic regime recommendations (non-binding):
  - if lambda_mfp / L << 1 -> suggest diffusion
  - if lambda_mfp / L ~ O(0.1 to 1) -> suggest intermediate
  - if lambda_mfp / L >= O(1) -> suggest Boltzmann

Acceptance criteria
- Intermediate mode runs for all existing geometries and preserves positivity/conservation tolerances.
- Intermediate mode converges to diffusion behavior in the strong-scattering limit.

--------------------------------------------------------------------------------
Phase 3: Phonon thermal relaxation dynamics (still decoupled from QP)
--------------------------------------------------------------------------------
Goal
- Add first real phonon dynamics, but no QP-phonon coupling yet.

Tasks
- Implement local relaxation-time model:
  - d n_ph(omega)/dt = -(n_ph - n_ph_eq(T_bath))/tau_th
- Optional simple spatial transport term for phonons (deferred if uncertain).
- Add omega bin grid and equilibrium Bose distribution utilities.
- Add BoltzPhlow-compatible collision-form implementation hook:
  - collision_phonon_relaxation(n_ph, T_bath, tau_th, omega_bins)
  - ready to be combined with QP-generated source/sink terms later.

Validation
- Analytic single-cell exponential relaxation tests.
- Stability tests for implicit/semimplicit integration path.

--------------------------------------------------------------------------------
Phase 4: Full QP-phonon coupling (core 2023 model)
--------------------------------------------------------------------------------
Goal
- Implement coupled collision integrals for QP and phonons.

Tasks
- Add QP collision terms:
  - phonon emission/absorption (number-conserving redistribution)
  - recombination and phonon-mediated pair-breaking
- Add phonon kinetic equation source/sink terms induced by QP processes.
- Preserve key invariants where applicable:
  - number conservation in conserving channels
  - correct detailed-balance equilibrium fixed point
- Add optional self-consistent gap update interface (initially disabled by default).

BoltzPhlow additions in Phase 4
- Implement collision integrals using a structure that can be evaluated either:
  - directly in O(N_E^2) / O(N_Omega*N_E), or
  - as convolution/correlation forms with FFT acceleration when algebraically valid.
- Add optional "time-relaxation" update path documented in BoltzPhlow notes:
  - prioritize positivity of f(E) and n(omega),
  - verify first-order energy conservation behavior numerically.
- Add explicit split of phonon equation domains:
  - sub-gap phonons (no pair-breaking generation term),
  - above-gap phonons (include recombination-generated phonons and pair-breaking coupling).
- Add self-consistent gap update mode:
  - fixed-gap (default),
  - quasi-static Delta(T, n_qp) update every N steps,
  - fully coupled update (experimental).

Numerics
- Move collision solve to stiff integrator by default (BDF/Radau style).
- Keep explicit mode only as experimental with warnings.

Validation
- Reproduce qualitative behaviors from Fischer 2023:
  - shape regimes
  - impact of finite phonon thermalization time
  - density trends with temperature and drive.

--------------------------------------------------------------------------------
Phase 5: Photon channels including pair-breaking photons (2024 model)
--------------------------------------------------------------------------------
Goal
- Add sub-gap and above-gap photon effects.

Tasks
- Non-pair-breaking photon channel:
  - number-conserving photon absorption/emission redistribution.
- Pair-breaking photon channel:
  - generation of QPs above threshold.
  - optional photon-assisted recombination term (can be toggled if negligible).
- Support both:
  - single pair-breaking mode
  - multiple modes / broadband source approximation.

BoltzPhlow additions in Phase 5
- Keep photon terms as pluggable collision sources so they can be enabled in:
  - homogeneous 0D runs,
  - spatial BTE-energy-shell runs.
- Add consistency checks ensuring photon terms do not break conserving identities in unrelated channels.

Regime handling
- Implement regime flags and diagnostics:
  - perturbative regime
  - heating regime
- Add generalized Rothwarf-Taylor reduced-density mode for fast scans.

Validation
- Match qualitative trends in Fischer 2024:
  - low-T saturation behavior from small above-gap photon populations
  - heating/perturbative crossover behavior.

--------------------------------------------------------------------------------
Phase 6: Derived observables and experiment-comparison mode
--------------------------------------------------------------------------------
Goal
- Compute measurable quantities from simulated distributions.

Tasks
- Internal quality factor estimate pipeline.
- Resonance frequency shift pipeline.
- Optional fit mode for effective above-gap photon contributions (constant + readout-dependent term).

Validation
- Compare to reference-style curves qualitatively and with configurable fit residual metrics.

--------------------------------------------------------------------------------
Phase 7: Gap-asymmetric junction module (2025 model)
--------------------------------------------------------------------------------
Goal
- Add a reduced two-electrode "junction mode" for qubit-style regimes.

Tasks
- New module (separate from 2D resonator path) for:
  - left/right electrode gap asymmetry
  - effective chemical potentials for energy sectors
  - coupled rate equations for QP densities and parity-related rates
- Regime classifier:
  - nonequilibrium
  - local quasiequilibrium
  - global quasiequilibrium
  - full equilibrium
- Optional magnetic-field sweep helper (Fraunhofer-oriented analysis interface).

Validation
- Verify expected regime transitions versus temperature and asymmetry parameters.

--------------------------------------------------------------------------------
Phase 8: Performance, caching, and reliability hardening
--------------------------------------------------------------------------------
Goal
- Make comprehensive model practical and robust.

Tasks
- Kernel precompute by unique local gap and model hash.
- Strict sidecar compatibility checks (parameter hash + version).
- Memory controls:
  - chunked kernels
  - optional reduced-order mode.
- Add non-negativity guards/limiters with diagnostics.

BoltzPhlow additions in Phase 8
- Introduce FFT-accelerated collision backend where applicable:
  - benchmark crossover sizes vs dense kernels.
- Add adaptive time-step controller driven by:
  - negativity risk,
  - conservation residual thresholds.
- Add optional IMEX scheme:
  - implicit stiff loss terms, explicit source/transport terms.

Validation
- Long-run stability, reproducibility tests, and benchmark suite.

--------------------------------------------------------------------------------
Cross-phase testing strategy
--------------------------------------------------------------------------------
1. Unit tests
- Kernels, distributions, serialization, shape/mask integrity, boundary behavior.

2. Physics invariants
- Equilibrium fixed-point tests (collision terms sum to zero).
- Conservation tests for number-conserving channels.

3. Regression tests
- Golden-case outputs for each model level.
- Backward compatibility for old setup/simulation files.

4. Numerical robustness tests
- dt sensitivity, solver fallback visibility, positivity checks.
- Conservation-residual envelopes:
  - max |Delta E_total| per step,
  - drift over full run,
  - per-channel residual decomposition.

5. BoltzPhlow consistency tests
- 0D coupled QP-phonon energy exchange with no external drive:
  - total energy conserved within tolerance.
- Relaxation-to-equilibrium checks:
  - fixed points for both QP and phonon distributions.
- Discretization convergence:
  - energy-bin refinement and timestep refinement studies.

--------------------------------------------------------------------------------
Repository-level implementation map
--------------------------------------------------------------------------------
- qpsim/models.py
  - extend data classes for phonon fields and model-level metadata.
- qpsim/storage.py
  - serialize/deserialize new fields with backward compatibility.
- qpsim/solver.py
  - staged addition of phonon state and coupled kinetics.
- qpsim/precompute.py
  - add phonon/QP coupling kernel precompute and compatibility hashes.
- qpsim/physics/
  - new module group for BoltzPhlow-style kernels and conservation utilities:
    - bte_kernels.py
    - conservation.py
    - gap_self_consistency.py
    - collision_backends.py
- qpsim/ui/main_app.py
  - new PhononViewer and launch controls; model-level toggles.
- tests/test_regressions.py (+ new test files)
  - phased validation coverage.

--------------------------------------------------------------------------------
Immediate next execution sequence
--------------------------------------------------------------------------------
1. Implement Phase 1 exactly (fixed-temperature phonon viewer, no coupling).
2. Merge solver correctness fixes required as precondition.
3. Perform Phase 2 refactor to unlock safe incremental physics additions.
4. Implement Phase 3 and Phase 4 with strict tests before moving to photon channels.
5. Add Phase 2.5 hybrid closure and validate transition consistency across transport modes.
6. Complete full tri-mode dispatch and expose final regime choice in UI and saved setup schema.

--------------------------------------------------------------------------------
BoltzPhlow add-on track (cross-cutting milestones)
--------------------------------------------------------------------------------
Milestone B1: Conservation instrumentation
- Add runtime monitors and persist conservation traces in simulation metadata.

Milestone B2: Positivity-first collision stepping
- Implement a robust default collision integrator path that avoids negative occupations.

Milestone B3: Energy-shell BTE backend
- Introduce a second backend implementing BoltzPhlow-style reduced BTE equations with identical UI surface.

Milestone B3.5: Tri-mode regime consistency
- Add cross-regime comparison harness:
  - diffusion vs intermediate agreement in diffusive limit,
  - intermediate vs Boltzmann agreement in weak-scattering/transitional cases.

Milestone B4: FFT collision acceleration
- Add FFT convolution/correlation path and select backend automatically by problem size.

Milestone B5: Gap self-consistency modes
- Add fixed / quasi-static / coupled gap update modes and benchmark stability and cost.
